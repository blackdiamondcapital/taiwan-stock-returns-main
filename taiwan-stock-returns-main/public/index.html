<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuantGem 報酬引擎</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="icon" href="data:,">
    <!-- 引入 Chart.js 圖表庫 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* 繼承原有的科技感配色系統 */
        :root {
            --primary-cyan: #00d4ff;
            --primary-magenta: #ff0080;
            --primary-green: #00ff88;
            --primary-orange: #ffaa00;
            --primary-red: #ff4757;
            
            --bg-primary: #0a0e1a;
            --bg-secondary: #1a1f2e;
            --bg-tertiary: #2a3441;
            --bg-glass: rgba(255, 255, 255, 0.05);
            --bg-card: rgba(26, 31, 46, 0.8);
            
            --text-primary: #ffffff;
            --text-secondary: #b3d9ff;
            --text-muted: #7a8ba3;
            
            --success: #00ff88;
            --error: #ff4444;
            --warning: #ffaa00;
            --info: #00d4ff;
            
            --border-primary: rgba(0, 212, 255, 0.3);
            --border-secondary: rgba(255, 255, 255, 0.1);
            --shadow-glow: 0 0 20px rgba(0, 212, 255, 0.3);
            --shadow-card: 0 8px 32px rgba(0, 0, 0, 0.3);
            
            --gradient-primary: linear-gradient(135deg, var(--primary-cyan), var(--primary-magenta));
            --gradient-card: linear-gradient(145deg, rgba(26, 31, 46, 0.9), rgba(42, 52, 65, 0.7));
            --gradient-button: linear-gradient(135deg, var(--primary-cyan), var(--primary-magenta));
            --gradient-success: linear-gradient(135deg, #00ff88, #00d4ff);
            --gradient-danger: linear-gradient(135deg, #ff4757, #ff0080);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
            background: 
                radial-gradient(circle at 20% 80%, rgba(0, 212, 255, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 0, 128, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(0, 255, 136, 0.2) 0%, transparent 50%),
                linear-gradient(135deg, #0a0e1a 0%, #1a1f2e 50%, #0f1419 100%);
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* 主容器 */
        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* 頭部 */
        .app-header {
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-primary);
            padding: 1.5rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-glow);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-title h1 {
            font-size: 1.8rem;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-title i {
            font-size: 1.5rem;
            color: var(--primary-cyan);
            filter: drop-shadow(0 0 8px var(--primary-cyan));
        }

        /* 主導航 */
        .main-nav {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-secondary);
            padding: 0 2rem;
            position: sticky;
            top: 88px; /* Adjusted for header height */
            z-index: 90;
        }

        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            gap: 2rem;
            padding: 1rem 0;
        }

        .nav-item {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: 12px;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 0.95rem;
            position: relative;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-item:hover {
            color: var(--text-primary);
            background: rgba(0, 212, 255, 0.05);
        }

        .nav-item.active {
            color: var(--text-primary);
            background: var(--gradient-primary);
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
        }

        /* 主內容區 */
        .main-content {
            flex: 1;
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        /* 統計卡片 */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--gradient-card);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-secondary);
            border-radius: 16px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: var(--gradient-primary);
            opacity: 0.05;
            transition: left 0.3s ease;
        }

        .stat-card:hover::before {
            left: 0;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 212, 255, 0.2);
            border-color: var(--primary-cyan);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            background: var(--gradient-primary);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: var(--text-primary);
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.3);
        }

        .stat-trend {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.75rem;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .stat-trend.up {
            background: rgba(0, 255, 136, 0.2);
            color: var(--success);
        }

        .stat-trend.down {
            background: rgba(255, 71, 87, 0.2);
            color: var(--primary-red);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            text-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 0.9rem;
            font-weight: 500;
        }

        /* 篩選控制面板 */
        .filter-panel {
            background: var(--gradient-card);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-secondary);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .filter-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .filter-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-label {
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .filter-input {
            background: rgba(26, 31, 46, 0.6);
            border: 1px solid var(--border-secondary);
            border-radius: 8px;
            padding: 0.75rem;
            color: var(--text-primary);
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }

        .filter-input:focus {
            outline: none;
            border-color: var(--primary-cyan);
            box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
        }

        /* 排行榜表格 */
        .ranking-table-container {
            background: var(--gradient-card);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-secondary);
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-secondary);
            background: rgba(0, 212, 255, 0.03);
        }

        .table-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .table-actions {
            display: flex;
            gap: 0.75rem;
        }

        .btn-icon, .btn-primary {
            background: rgba(26, 31, 46, 0.6);
            border: 1px solid var(--border-secondary);
            border-radius: 8px;
            padding: 0.5rem 0.75rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .btn-icon:hover, .btn-primary:hover {
            border-color: var(--primary-cyan);
            background: rgba(0, 212, 255, 0.1);
            color: var(--primary-cyan);
        }

        .ranking-table {
            width: 100%;
            border-collapse: collapse;
        }

        .ranking-table thead {
            background: rgba(0, 212, 255, 0.08);
        }

        .ranking-table th {
            padding: 1rem;
            text-align: left;
            color: var(--text-primary);
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 2px solid var(--border-secondary);
            cursor: pointer;
            position: relative;
        }

        .ranking-table th:hover {
            background: rgba(0, 212, 255, 0.1);
        }

        .sort-indicator {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 0.8rem;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .ranking-table th.sorted .sort-indicator {
            opacity: 1;
            color: var(--primary-cyan);
        }


        .ranking-table tbody tr {
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }

        .ranking-table tbody tr:hover {
            background: rgba(0, 212, 255, 0.05);
        }

        .ranking-table td {
            padding: 1rem;
            color: var(--text-muted);
            font-size: 0.95rem;
            vertical-align: middle;
        }

        .rank-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .rank-badge.gold {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #000;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }

        .rank-badge.silver {
            background: linear-gradient(135deg, #C0C0C0, #808080);
            color: #000;
            box-shadow: 0 0 15px rgba(192, 192, 192, 0.5);
        }

        .rank-badge.bronze {
            background: linear-gradient(135deg, #CD7F32, #8B4513);
            color: #fff;
            box-shadow: 0 0 15px rgba(205, 127, 50, 0.5);
        }

        .stock-info {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .stock-symbol {
            font-weight: 700;
            color: var(--primary-cyan);
            text-shadow: 0 0 8px rgba(0, 212, 255, 0.3);
        }

        .stock-name {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .return-value {
            font-weight: 600;
            font-family: 'Monaco', 'Consolas', monospace;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .return-value.positive {
            color: var(--success);
            text-shadow: 0 0 8px rgba(0, 255, 136, 0.3);
        }

        .return-value.negative {
            color: var(--primary-red);
            text-shadow: 0 0 8px rgba(255, 71, 87, 0.3);
        }

        /* 時間範圍選擇器 */
        .period-selector {
            display: flex;
            gap: 0.5rem;
            background: rgba(26, 31, 46, 0.6);
            border: 1px solid var(--border-secondary);
            border-radius: 10px;
            padding: 0.25rem;
        }

        .period-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .period-btn:hover {
            color: var(--text-primary);
            background: rgba(0, 212, 255, 0.1);
        }

        .period-btn.active {
            color: var(--text-primary);
            background: var(--gradient-primary);
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.3);
        }

        /* 圖表容器 */
        .chart-container {
            background: var(--gradient-card);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-secondary);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .chart-placeholder {
            text-align: center;
            color: var(--text-muted);
        }

        .chart-placeholder i {
            font-size: 3rem;
            color: var(--primary-cyan);
            margin-bottom: 1rem;
            display: block;
        }

        /* 分析工具 */
        .analysis-section {
            margin-bottom: 2rem;
        }
        .analysis-tools {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        .tool-card {
            background: var(--gradient-card);
            border: 1px solid var(--border-secondary);
            border-radius: 16px;
            padding: 1.5rem;
        }
        .tool-card h3 {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }
        .tool-content {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .risk-meter {
            width: 100%;
            height: 20px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        .risk-level {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 700;
            color: #fff;
            transition: width 0.5s ease;
        }
        .risk-level.low { background: var(--gradient-success); width: 25%; }
        .risk-level.medium { background: linear-gradient(135deg, var(--warning), var(--primary-green)); width: 50%; }
        .risk-level.high { background: var(--gradient-danger); width: 75%; }
        #calculatorResult {
            color: var(--primary-cyan);
            font-weight: bold;
            margin-top: 0.5rem;
            min-height: 1.2em;
        }


        /* 響應式設計 */
        @media (max-width: 768px) {
            .header-content, .main-nav, .main-content {
                padding-left: 1rem;
                padding-right: 1rem;
            }
            .stats-grid, .filter-controls, .analysis-tools {
                grid-template-columns: 1fr;
            }
            .ranking-table {
                display: block;
                overflow-x: auto;
            }
            .nav-container {
                overflow-x: auto;
                gap: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- 頭部 -->
        <header class="app-header">
            <div class="header-content">
                <div class="header-title">
                    <i class="fas fa-chart-line"></i>
                    <h1>QuantGem 報酬引擎</h1>
                </div>
                <div class="header-actions">
                    <button class="btn-icon" onclick="refreshData()">
                        <i class="fas fa-sync-alt"></i>
                        重新整理
                    </button>
                </div>
            </div>
        </header>

        <!-- 主導航 -->
        <nav class="main-nav">
            <div class="nav-container">
                <button class="nav-item active" data-view="overview">
                    <i class="fas fa-tachometer-alt"></i>
                    總覽
                </button>
                <button class="nav-item" data-view="ranking">
                    <i class="fas fa-trophy"></i>
                    排行榜
                </button>
                <button class="nav-item" data-view="analysis">
                    <i class="fas fa-chart-bar"></i>
                    深度分析
                </button>
                <button class="nav-item" data-view="comparison">
                    <i class="fas fa-balance-scale"></i>
                    比較工具
                </button>
                <button class="nav-item" data-view="alerts">
                    <i class="fas fa-bell"></i>
                    警示設定
                </button>
            </div>
        </nav>

        <!-- 主內容區 -->
        <main class="main-content">
            <!-- 統計卡片 -->
            <div class="stats-grid">
                 <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-arrow-trend-up"></i>
                        </div>
                        <div class="stat-trend up" id="risingTrend">
                            <i class="fas fa-arrow-up"></i>
                            12.5%
                        </div>
                    </div>
                    <div class="stat-value" id="risingStocks">156</div>
                    <div class="stat-label">今日上漲股票數</div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-crown"></i>
                        </div>
                        <div class="stat-trend up" id="topReturnTrend">
                            <i class="fas fa-arrow-up"></i>
                            28.3%
                        </div>
                    </div>
                    <div class="stat-value" id="topStock">2330.TW</div>
                    <div class="stat-label">本月最佳報酬</div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-chart-pie"></i>
                        </div>
                        <div class="stat-trend down" id="avgReturnTrend">
                            <i class="fas fa-arrow-down"></i>
                            3.2%
                        </div>
                    </div>
                    <div class="stat-value" id="avgReturn">8.7%</div>
                    <div class="stat-label">市場平均報酬率</div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-fire"></i>
                        </div>
                         <div class="stat-trend up">
                            <i class="fas fa-arrow-up"></i>
                            新高
                        </div>
                    </div>
                    <div class="stat-value" id="newHighStocks">23</div>
                    <div class="stat-label">突破新高股票</div>
                </div>
            </div>

            <!-- 篩選控制面板 -->
            <div class="filter-panel">
                <div class="filter-header">
                    <div class="filter-title">
                        <i class="fas fa-filter"></i>
                        篩選條件
                    </div>
                    <div class="period-selector">
                        <button class="period-btn active" data-period="daily">日</button>
                        <button class="period-btn" data-period="weekly">週</button>
                        <button class="period-btn" data-period="monthly">月</button>
                        <button class="period-btn" data-period="quarterly">季</button>
                        <button class="period-btn" data-period="yearly">年</button>
                    </div>
                </div>
                <div class="filter-controls">
                    <div class="filter-group">
                        <label class="filter-label">市場類別</label>
                        <select class="filter-input" id="marketFilter">
                            <option value="all">全部市場</option>
                            <option value="listed">上市</option>
                            <option value="otc">上櫃</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">產業類別</label>
                        <select class="filter-input" id="industryFilter">
                            <option value="all">全部產業</option>
                            <option value="semiconductor">半導體</option>
                            <option value="finance">金融保險</option>
                            <option value="shipping">航運業</option>
                            <option value="steel">鋼鐵工業</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">報酬率範圍</label>
                        <select class="filter-input" id="returnFilter">
                            <option value="all">全部</option>
                            <option value="top10">前10%</option>
                            <option value="positive">正報酬</option>
                            <option value="negative">負報酬</option>
                            <option value="extreme">極端值 (±20%)</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">成交量門檻</label>
                        <select class="filter-input" id="volumeFilter">
                            <option value="all">全部</option>
                            <option value="10000">&gt; 10000張</option>
                            <option value="1000">&gt; 1000張</option>
                            <option value="100">&gt; 100張</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- 報酬率排行榜 -->
            <div class="ranking-table-container">
                <div class="table-header">
                    <div class="table-title">
                        <i class="fas fa-trophy"></i>
                        報酬率排行榜
                    </div>
                </div>
                <table class="ranking-table">
                    <thead>
                        <tr>
                            <th data-sort="rank">排名 <span class="sort-indicator"></span></th>
                            <th data-sort="symbol">股票代碼 <span class="sort-indicator"></span></th>
                            <th data-sort="return">報酬率 <span class="sort-indicator"></span></th>
                            <th data-sort="price">現價 <span class="sort-indicator"></span></th>
                            <th data-sort="change">漲跌 <span class="sort-indicator"></span></th>
                            <th data-sort="volume">成交量 <span class="sort-indicator"></span></th>
                            <th data-sort="cumulative">累積報酬 <span class="sort-indicator"></span></th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="rankingTableBody">
                        <!-- 數據將由 JS 動態生成 -->
                    </tbody>
                </table>
            </div>

            <!-- 圖表容器 -->
            <div class="chart-container" id="chartContainer">
                <div class="chart-placeholder">
                    <i class="fas fa-chart-area"></i>
                    <p>選擇股票查看報酬率趨勢圖</p>
                </div>
            </div>

            <!-- 分析工具區 -->
            <div class="analysis-section" style="display: none;">
                <div class="analysis-tools">
                    <div class="tool-card">
                        <h3><i class="fas fa-calculator"></i> 報酬率計算器</h3>
                        <div class="tool-content">
                            <input type="number" id="buyPrice" placeholder="輸入買入價格" class="filter-input">
                            <input type="number" id="sellPrice" placeholder="輸入賣出價格" class="filter-input">
                            <button class="btn-primary" id="calculateReturnBtn">計算報酬率</button>
                            <p id="calculatorResult"></p>
                        </div>
                    </div>
                    
                    <div class="tool-card">
                        <h3 id="riskAssessmentTitle"><i class="fas fa-balance-scale"></i> 風險評估</h3>
                        <div class="tool-content">
                            <div class="risk-meter">
                                <div id="riskLevelIndicator" class="risk-level medium">中等風險</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // 全局變數
        let currentSort = { column: 'return', direction: 'desc' };
        let chartInstance = null;
        let currentData = [];

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
            loadRankingData();
        });

        // 事件監聽器初始化
        function initializeEventListeners() {
            // 導航切換
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                    this.classList.add('active');
                    switchView(this.dataset.view);
                });
            });

            // 時間範圍選擇
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    applyFilters();
                });
            });

            // 篩選器變更
            document.querySelectorAll('.filter-input').forEach(input => {
                input.addEventListener('change', applyFilters);
            });
            
            // 表格排序
            document.querySelectorAll('.ranking-table th[data-sort]').forEach(header => {
                header.addEventListener('click', () => {
                    const column = header.dataset.sort;
                    if (currentSort.column === column) {
                        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSort.column = column;
                        currentSort.direction = 'desc';
                    }
                    applyFilters(); // Re-apply filters which will also sort
                    updateSortIndicators();
                });
            });

            // 報酬率計算器
            document.getElementById('calculateReturnBtn').addEventListener('click', () => {
                const buyPrice = parseFloat(document.getElementById('buyPrice').value);
                const sellPrice = parseFloat(document.getElementById('sellPrice').value);
                const resultEl = document.getElementById('calculatorResult');

                if (isNaN(buyPrice) || isNaN(sellPrice) || buyPrice <= 0) {
                    resultEl.textContent = '請輸入有效的買入和賣出價格。';
                    resultEl.style.color = 'var(--error)';
                    return;
                }

                const returnValue = ((sellPrice - buyPrice) / buyPrice) * 100;
                resultEl.textContent = `報酬率: ${returnValue.toFixed(2)}%`;
                resultEl.style.color = returnValue >= 0 ? 'var(--success)' : 'var(--error)';
            });
        }
        
        // 更新排序指示器
        function updateSortIndicators() {
            document.querySelectorAll('.ranking-table th[data-sort]').forEach(th => {
                th.classList.remove('sorted', 'asc', 'desc');
                const indicator = th.querySelector('.sort-indicator');
                if (th.dataset.sort === currentSort.column) {
                    th.classList.add('sorted', currentSort.direction);
                    indicator.innerHTML = currentSort.direction === 'asc' ? '<i class="fas fa-arrow-up"></i>' : '<i class="fas fa-arrow-down"></i>';
                } else {
                     indicator.innerHTML = '';
                }
            });
        }


        // 視圖切換函數
        function setVisibility(selector, display) {
            document.querySelector(selector).style.display = display;
        }

        function switchView(view) {
            const isOverview = view === 'overview';
            const isRanking = view === 'ranking';
            const isAnalysis = view === 'analysis';

            setVisibility('.stats-grid', isOverview ? 'grid' : 'none');
            setVisibility('.filter-panel', isOverview || isRanking || isAnalysis ? 'block' : 'none');
            setVisibility('.ranking-table-container', isOverview || isRanking ? 'block' : 'none');
            setVisibility('.chart-container', isOverview || isAnalysis ? 'flex' : 'none');
            setVisibility('.analysis-section', isAnalysis ? 'block' : 'none');

            if(isOverview || isRanking) applyFilters();
            if(isAnalysis) console.log("切換到深度分析視圖");
        }

        // 載入並處理數據
        async function loadRankingData() {
            try {
                await loadRankingFromAPI();
                await loadStatisticsFromAPI();
            } catch (error) {
                console.error('載入數據失敗:', error);
                // 如果 API 失敗，使用模擬數據作為備用
                currentData = getMockData();
                applyFilters();
            }
        }
        
        // API 基礎 URL
        const API_BASE_URL = 'http://localhost:3000/api';

        // 從 API 載入排行榜數據
        async function loadRankingFromAPI() {
            try {
                const period = document.querySelector('.period-btn.active').dataset.period;
                const filters = {
                    market: document.getElementById('marketFilter').value,
                    industry: document.getElementById('industryFilter').value,
                    returnRange: document.getElementById('returnFilter').value,
                    volumeThreshold: parseInt(document.getElementById('volumeFilter').value) || 0
                };

                const params = new URLSearchParams({
                    period,
                    ...filters,
                    limit: 50
                });

                const response = await fetch(`${API_BASE_URL}/returns/rankings?${params}`);
                const data = await response.json();

                if (data.success) {
                    const result = data;
                    currentData = result.data.map((item, index) => ({
                        rank: item.rank || index + 1,
                        symbol: item.symbol,
                        name: item.name,
                        return: parseFloat(item.return_rate) || 0,
                        price: parseFloat(item.price) || 0,
                        change: parseFloat(item.change) || 0,
                        volume: parseInt(item.volume) || 0,
                        cumulative: parseFloat(item.cumulative) || 0,
                        market: item.market,
                        industry: item.industry,
                        volatility: parseFloat(item.volatility) || 0.5
                    }));
                    updateRankingTable(currentData);
                } else {
                    throw new Error(result.error || 'API 調用失敗');
                }
            } catch (error) {
                console.error('載入排行榜數據失敗:', error);
                throw error;
            }
        }

        // 從 API 載入統計數據
        async function loadStatisticsFromAPI() {
            try {
                const period = document.querySelector('.period-btn.active').dataset.period;
                const response = await fetch(`${API_BASE_URL}/returns/statistics?period=${period}`);
                const result = await response.json();

                if (result.success) {
                    const stats = result.data;
                    document.getElementById('risingStocks').textContent = stats.risingStocks;
                    document.getElementById('topStock').textContent = stats.topStock;
                    document.getElementById('avgReturn').textContent = `${stats.avgReturn.toFixed(1)}%`;
                    document.getElementById('newHighStocks').textContent = stats.newHighStocks;
                } else {
                    throw new Error(result.error || '統計數據載入失敗');
                }
            } catch (error) {
                console.error('載入統計數據失敗:', error);
            }
        }

        // 應用所有篩選和排序
        async function applyFilters() {
            try {
                await loadRankingFromAPI();
            } catch (error) {
                console.error('篩選失敗，使用模擬數據:', error);
                // 備用方案：使用模擬數據
                const period = document.querySelector('.period-btn.active').dataset.period;
                let filteredData = getMockDataForPeriod(period);

                // 篩選邏輯
                const filters = {
                    market: document.getElementById('marketFilter').value,
                    industry: document.getElementById('industryFilter').value,
                    returnRange: document.getElementById('returnFilter').value,
                    volume: parseInt(document.getElementById('volumeFilter').value) || 0
                };

                if (filters.market !== 'all') {
                    filteredData = filteredData.filter(item => item.market === filters.market);
                }
                if (filters.industry !== 'all') {
                    filteredData = filteredData.filter(item => item.industry === filters.industry);
                }
                if (filters.volume > 0) {
                    filteredData = filteredData.filter(item => item.volume >= filters.volume);
                }
                if (filters.returnRange === 'positive') {
                    filteredData = filteredData.filter(item => item.return > 0);
                } else if (filters.returnRange === 'negative') {
                    filteredData = filteredData.filter(item => item.return < 0);
                } else if (filters.returnRange === 'top10') {
                    filteredData.sort((a, b) => b.return - a.return);
                    filteredData = filteredData.slice(0, Math.ceil(getMockData().length * 0.1));
                } else if (filters.returnRange === 'extreme') {
                    filteredData = filteredData.filter(item => Math.abs(item.return) > 20);
                }

                // 排序邏輯
                sortData(filteredData);
                updateRankingTable(filteredData);
            }
            updateSortIndicators();
        }

        // 排序數據
        function sortData(data) {
             data.sort((a, b) => {
                const aVal = a[currentSort.column];
                const bVal = b[currentSort.column];

                if (typeof aVal === 'string') {
                    return currentSort.direction === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                } else {
                    return currentSort.direction === 'asc' ? aVal - bVal : bVal - aVal;
                }
            });
            // Re-assign rank after sorting
             data.forEach((item, index) => item.rank = index + 1);
        }

        // 更新排行榜表格
        function updateRankingTable(data) {
            const tbody = document.getElementById('rankingTableBody');
            tbody.innerHTML = '';
            data.forEach(item => {
                const row = createRankingRow(item);
                tbody.appendChild(row);
            });
        }
        
        // 創建排行榜行
        function createRankingRow(item) {
            const tr = document.createElement('tr');
            let rank = item.rank;
            let rankClass = '';
            if (rank === 1) rankClass = 'gold';
            else if (rank === 2) rankClass = 'silver';
            else if (rank === 3) rankClass = 'bronze';
            
            const returnClass = item.return >= 0 ? 'positive' : 'negative';
            const arrow = item.return >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
            
            tr.innerHTML = `
                <td><span class="rank-badge ${rankClass}">${rank}</span></td>
                <td><div class="stock-info"><span class="stock-symbol">${item.symbol}</span><span class="stock-name">${item.name}</span></div></td>
                <td><span class="return-value ${returnClass}"><i class="fas ${arrow}"></i> ${item.return.toFixed(2)}%</span></td>
                <td>${item.price.toFixed(2)}</td>
                <td class="${returnClass}">${item.change >= 0 ? '+' : ''}${item.change.toFixed(2)}</td>
                <td>${item.volume.toLocaleString()}</td>
                <td><span class="return-value ${item.cumulative >= 0 ? 'positive' : 'negative'}">${item.cumulative.toFixed(2)}%</span></td>
                <td><button class="btn-icon" onclick="viewDetails('${item.symbol}')"><i class="fas fa-chart-line"></i></button></td>
            `;
            return tr;
        }

        // 更新統計數據
        function updateStatistics() {
            const mockStats = {
                risingStocks: 156,
                topStock: '2330.TW',
                avgReturn: 8.7,
                newHighStocks: 23
            };
            document.getElementById('risingStocks').textContent = mockStats.risingStocks;
            document.getElementById('topStock').textContent = mockStats.topStock;
            document.getElementById('avgReturn').textContent = `${mockStats.avgReturn}%`;
            document.getElementById('newHighStocks').textContent = mockStats.newHighStocks;
        }

        // 查看詳情 (顯示圖表)
        function viewDetails(symbol) {
            console.log('Viewing details for:', symbol);
            renderStockChart(symbol);
            updateAnalysisTools(symbol);
        }

        // 渲染股票圖表
        function renderStockChart(symbol) {
            const chartContainer = document.getElementById('chartContainer');
            chartContainer.innerHTML = '<canvas id="stockChart"></canvas>'; // 清除佔位符並加入 canvas
            const ctx = document.getElementById('stockChart').getContext('2d');
            
            const stock = getMockData().find(s => s.symbol === symbol);

            // 模擬歷史數據
            const labels = Array.from({length: 30}, (_, i) => `Day ${i + 1}`);
            const data = Array.from({length: 30}, () => stock.return + (Math.random() - 0.5) * 10);

            if(chartInstance) {
                chartInstance.destroy(); // 銷毀舊圖表實例
            }

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `${symbol} 報酬率趨勢 (%)`,
                        data: data,
                        borderColor: 'rgba(0, 212, 255, 1)',
                        backgroundColor: 'rgba(0, 212, 255, 0.1)',
                        fill: true,
                        tension: 0.4,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { 
                            ticks: { color: 'var(--text-secondary)'},
                            grid: { color: 'var(--border-secondary)'}
                        },
                        x: {
                            ticks: { color: 'var(--text-secondary)'},
                             grid: { color: 'var(--border-secondary)'}
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: 'var(--text-primary)' }
                        }
                    }
                }
            });
        }
        
        // 更新分析工具
        function updateAnalysisTools(symbol) {
            const stock = getMockData().find(s => s.symbol === symbol);
            if (!stock) return;

            // 更新風險評估
            document.getElementById('riskAssessmentTitle').innerHTML = `<i class="fas fa-balance-scale"></i> ${symbol} 風險評估`;
            const riskIndicator = document.getElementById('riskLevelIndicator');
            riskIndicator.className = 'risk-level'; // Reset classes
            
            if (stock.volatility < 0.3) {
                riskIndicator.classList.add('low');
                riskIndicator.textContent = '低風險';
            } else if (stock.volatility < 0.6) {
                riskIndicator.classList.add('medium');
                riskIndicator.textContent = '中等風險';
            } else {
                riskIndicator.classList.add('high');
                riskIndicator.textContent = '高風險';
            }
        }
        
        // 重新整理數據
        function refreshData() {
            loadRankingData();
            updateStatistics();
            const chartContainer = document.getElementById('chartContainer');
            chartContainer.innerHTML = `
                <div class="chart-placeholder">
                    <i class="fas fa-chart-area"></i>
                    <p>選擇股票查看報酬率趨勢圖</p>
                </div>`;
            if (chartInstance) {
                chartInstance.destroy();
                chartInstance = null;
            }
        }

        // 根據期間獲取模擬數據
        function getMockDataForPeriod(period) {
            const baseData = getMockData();
            const multiplier = { 'daily': 0.1, 'weekly': 0.5, 'monthly': 1, 'quarterly': 3, 'yearly': 12 }[period] || 1;
            return baseData.map(item => ({ ...item, return: item.return * multiplier, cumulative: item.cumulative * multiplier }));
        }

        // 模擬數據生成
        function getMockData() {
            return [
                { rank: 1, symbol: '2330.TW', name: '台積電', return: 15.8, price: 580, change: 25, volume: 15234, cumulative: 45.2, market: 'listed', industry: 'semiconductor', volatility: 0.4 },
                { rank: 2, symbol: '2454.TW', name: '聯發科', return: 12.3, price: 850, change: 30, volume: 8567, cumulative: 38.7, market: 'listed', industry: 'semiconductor', volatility: 0.5 },
                { rank: 3, symbol: '2317.TW', name: '鴻海', return: 10.5, price: 108.5, change: 5.5, volume: 25432, cumulative: 28.3, market: 'listed', industry: 'semiconductor', volatility: 0.6 },
                { rank: 4, symbol: '2603.TW', name: '長榮', return: 25.2, price: 150, change: 10, volume: 150321, cumulative: 80.1, market: 'listed', industry: 'shipping', volatility: 0.9 },
                { rank: 5, symbol: '2881.TW', name: '富邦金', return: 8.2, price: 65.5, change: 3.2, volume: 12345, cumulative: 18.5, market: 'listed', industry: 'finance', volatility: 0.2 },
                { rank: 6, symbol: '2882.TW', name: '國泰金', return: 7.5, price: 58.3, change: 2.8, volume: 10234, cumulative: 15.3, market: 'listed', industry: 'finance', volatility: 0.25 },
                { rank: 7, symbol: '2303.TW', name: '聯電', return: 6.8, price: 45.2, change: 2.1, volume: 18765, cumulative: 12.8, market: 'listed', industry: 'semiconductor', volatility: 0.55 },
                { rank: 8, symbol: '6446.TW', name: '藥華藥', return: 18.9, price: 450, change: 22, volume: 5321, cumulative: 55.6, market: 'otc', industry: 'biotech', volatility: 0.8 },
                { rank: 9, symbol: '3008.TW', name: '大立光', return: -2.3, price: 2150, change: -45, volume: 567, cumulative: 8.5, market: 'listed', industry: 'semiconductor', volatility: 0.7 },
                { rank: 10, symbol: '2002.TW', name: '中鋼', return: -3.5, price: 28.5, change: -1.2, volume: 23456, cumulative: -5.2, market: 'listed', industry: 'steel', volatility: 0.3 }
            ];
        }

    </script>
</body>
</html>